<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:model="clr-namespace:TrackCubed.Shared.Models;assembly=TrackCubed.Shared"
             xmlns:dtos="clr-namespace:TrackCubed.Shared.DTOs;assembly=TrackCubed.Shared"
             xmlns:viewmodel="clr-namespace:TrackCubed.Maui.ViewModels"
             x:DataType="viewmodel:MainPageViewModel"
             x:Class="TrackCubed.Maui.Views.MainPage"
              Title="{Binding Title}"
             BackgroundColor="{AppThemeBinding Light={StaticResource PageBackgroundColorLight}, Dark={StaticResource PageBackgroundColorDark}}">


    <!-- Three rows: Filters (Auto), List (*), Button (Auto) -->
    <Grid RowDefinitions="Auto, *, Auto">

        <!-- Change Grid to have a row for controls -->
        <!-- Row 0: Search and Filter Controls -->
        <VerticalStackLayout Grid.Row="0" Padding="10" Spacing="5">
            <SearchBar Placeholder="Search text fields..."
                   Text="{Binding SearchText}" />
            <Picker Title="Filter by Type"
                ItemsSource="{Binding ItemTypeFilterOptions}"
                SelectedItem="{Binding SelectedItemTypeFilter}" />


            <!-- Input for adding a new tag filter -->
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                <Entry Grid.Column="0" 
                   Placeholder="Add a tag to filter"
                   Text="{Binding TagSearchText}" 
                   ReturnCommand="{Binding AddTagFilterCommand}"/>
                <Button Grid.Column="1" 
                    Text="Filter Tag" 
                    Command="{Binding AddTagFilterCommand}" />
            </Grid>

            <!-- Display area for currently applied tag filters -->
            <FlexLayout BindableLayout.ItemsSource="{Binding AppliedTags}" 
                    Wrap="Wrap" 
                    Margin="0,5,0,0">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="{x:Type x:String}">
                        <Frame Padding="10,5" Margin="0,0,5,5" CornerRadius="15" 
                           BackgroundColor="{StaticResource Secondary}">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="{Binding .}" 
                                   TextColor="{StaticResource Primary}" 
                                   VerticalOptions="Center"/>
                                <Button Grid.Column="1" Text="X" FontSize="10" 
                                    TextColor="{StaticResource Primary}"
                                    BackgroundColor="Transparent"
                                    BorderWidth="0"
                                    Padding="0" HeightRequest="20" WidthRequest="20"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainPageViewModel}}, Path=RemoveTagFilterCommand}"
                                    CommandParameter="{Binding .}"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </FlexLayout>


        </VerticalStackLayout>
        <!-- The RefreshView wraps the list and provides pull-to-refresh -->
        <RefreshView Grid.Row="1"
                     Command="{Binding LoadItemsCommand}"
                     IsRefreshing="{Binding LoadItemsCommand.IsRunning}">
            <CollectionView ItemsSource="{Binding Items}"
                            VerticalOptions="Fill">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dtos:CubedItemDto">
                        <Frame Padding="15" Margin="10" CornerRadius="8" HasShadow="True"
                               BackgroundColor="{AppThemeBinding Light={StaticResource FrameBackgroundColorLight}, Dark={StaticResource FrameBackgroundColorDark}}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer 
                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainPageViewModel}}, Path=GoToEditItemCommand}"
                            CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>
                            
                            <!-- We use a Grid to position the details and the button -->
                            <Grid RowDefinitions="Auto, Auto, *, Auto" ColumnDefinitions="*, Auto" RowSpacing="5">
                                <!-- Row 0, Column 0: The item details -->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="5">
                                    <Label Text="{Binding Name}" FontSize="Large" FontAttributes="Bold" 
                                           TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColorLight}, Dark={StaticResource PrimaryTextColorDark}}"/>
                                    <Label Text="{Binding Description}" FontSize="Small" 
                                           TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColorLight}, Dark={StaticResource SecondaryTextColorDark}}"/>
                                    <Label Text="{Binding Link, StringFormat='Source: {0}'}" FontSize="Micro" 
                                           TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColorLight}, Dark={StaticResource SecondaryTextColorDark}}"/>
                                    <Label Text="{Binding ItemType, StringFormat='Type: {0}'}"
                                           FontSize="Micro"
                                           FontAttributes="Italic"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                           Margin="0,5,0,0" />

                                </VerticalStackLayout>
                                <!-- Row 0, Column 1: The delete button -->
                                <Button Grid.Row="0" Grid.Column="1" 
                                Text="Delete" 
                                VerticalOptions="Start"
                                BackgroundColor="Red"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainPageViewModel}}, Path=DeleteCubedItemCommand}"
                                CommandParameter="{Binding .}"/>

                                <!-- Row 1, Column 0 (spans both columns): The tags -->
                                <FlexLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                    BindableLayout.ItemsSource="{Binding Tags}"
                                    Wrap="Wrap"
                                    Margin="0,10,0,0">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="{x:Type x:String}">
                                            <Frame Padding="8,4" Margin="0,0,5,5" CornerRadius="10" 
                                           BackgroundColor="{StaticResource Secondary}">
                                                <Label Text="{Binding .}" 
                                               TextColor="{StaticResource Primary}" 
                                               FontSize="10"/>
                                            </Frame>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <Button Grid.Row="2" 
                Text="Add New Item" 
                Command="{Binding AddNewItemCommand}"
                Margin="20" />
    </Grid>
</ContentPage>
